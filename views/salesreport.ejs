<%- include('partials/head.ejs') %> 
<%- include('partials/navbar.ejs') %>

<link rel="stylesheet" href="css/adminpanel.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"/>

<div class="container ml-2 p-4 d-flex">
    <div class="col-3 bg-light shadow rounded" style="height: 70vh; width: 35vh">
        <div class="w-100 bg-bookso text-center py-2 fw-bold font-color-secondary rounded-top" >ADMIN PANEL</div>
        <div class="w-100 h-75 d-flex flex-column ps-4 justify-content-around text-bookso fw-bold mt-3 custom-text-shadow">
            <a class="text-decoration-none text-bookso" href="/admin"><div><i class="fa-solid fa-layer-group pe-2" style="color: #535351;"></i>DASHBOARD</div></a>
            <a class="text-decoration-none text-bookso" href="/admin/products"><div><i class="fa-solid fa-cubes-stacked pe-2" style="color: #535351;"></i>PRODUCTS</div></a>
            <a class="text-decoration-none text-bookso" href="/admin/customers"><div><i class="fa-solid fa-users pe-2" style="color: #535351;"></i>CUSTOMERS</div></a>
            <a class="text-decoration-none text-bookso" href="/admin/orders"><div><i class="fa-solid fa-cart-shopping pe-2" style="color: #535351;"></i>ORDERS</div></a>
            <a class="text-decoration-none text-bookso" href="/admin/category"><div><i class="fa-solid fa-list pe-2" style="color: #535351;"></i>CATEGORY</div></a>
            <a class="text-decoration-none text-bookso" href="/admin/salesreport"><div><i class="fa-solid fa-universal-access pe-2" style="color: #535351;"></i>SALES REPORT</div></a>
            <a class="text-decoration-none text-bookso" href="/admin/listCoupon"><div><i class="fa-solid fa-ticket-simple pe-2" style="color: #535351;"></i>MANAGE COUPONS</div></a>
        </div>
    </div>

    <div class="col-9 px-4">
        <div class="container col-md-12" style="display: flex;justify-content: center;align-items: center;">
        
            <!-- <div class="content  col-md-11 ">
                <div class="col">
                  <h5 class="mb-3 fw-bold">Filter Sales Report</h5>
                  <div class="d-flex mb-3">
                    <div class=" me-3 mb-2">
                      <button class="btn btn-secondary dropdown-toggle"type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Payment Method
                      </button>
                      <ul class="dropdown-menu">
                        <button id="cod" class="dropdown-item payment-method-btn" href="#">COD</button>
                        <button id="Razorpay" class="dropdown-item payment-method-btn" href="#">Card</button>
                        <button id="Razorpay" class="dropdown-item payment-method-btn" href="#">Wallet</button>
                        <li><a id="all" class="dropdown-item" href="">All</a></li>
                      </ul>
                    </div> -->

                    <div class="d-flex flex-column border p-2 mx-1">
                      <h6>Payment method</h6>
                      <div class="form-check">
                      
                        <input class="form-check-input" onchange="handleChange(event)" name="COD" type="checkbox" value="" id="code" checked >
                        <label class="form-check-label" for="code">
                          COD
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" onchange="handleChange(event)" name="Card" type="checkbox" value="" id="card"  checked >
                        <label class="form-check-label" for="card">
                          Card
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" onchange="handleChange(event)" name="Wallet" type="checkbox" value="" id="wallet"  checked >
                        <label class="form-check-label" for="wallet">
                          Wallet
                        </label>
                      </div>
                    </div>
                  
            
                    <!-- <div class=" me-3 mb-2">
                      <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Order Time
                      </button>
                      <ul class="dropdown-menu">
                        <li><button id="today" class="dropdown-item" href="#">Today</button></li>
                        <li><button id="week" class="dropdown-item" href="#">Last 7 days</button></li>
                        <li><button id="month" class="dropdown-item">Last 30 days</button></li>
                        <li><button id="year" class="dropdown-item">Last 365 days</button></li>
                      </ul>
                    </div>
                    <div>
                      <div class=" mb-2">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          Select Date
                        </button>
                        <ul class="dropdown-menu">
                          <form action="#" id="dateForm">
                            <li class="dropdown-item text-muted" href="#">From</li>
                            <li> <input type="date" name="startDate" id="EndDate" class="mb-3 dropdown-item"></li>
                            <li class="dropdown-item text-muted" href="#">To</li>
                            <li> <input type="date" name="endDate" id="endDate" class="mb-3 dropdown-item"></li>
                            <li class="dropdown-item"><button type="submit" class="btn btn-dark ">Get Report</button></li>
                          </form>
                        </ul>
                        <p id="dateErr" class="mb-3 text-danger"></p>
                      </div>
                    </div> -->
                   
                      <div class="ms-auto">
                        <button class="btn btn-success" id="downloadPdf" onclick="downloadPdf()">Download PDF</button>
                      </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table" id="salesReport">
                      <thead>
                        <tr>
                          <th scope="col">Order Id</th>
                          <th scope="col">User</th>
                          <th scope="col">Date</th>
                          <th scope="col">Total No of Items</th>
                          <th scope="col">Total</th>
                          <th scope="col">Payment Method</th>
                        </tr>
                      </thead>
                      <tbody class="table-group-divider">
                        <tbody class="table-group-divider" id="table-body">
                          <% salesReport.forEach(order => { %>      
                              <tr>
                                <td><%= order._id %></td>
                                <td><%= order.userId?.name%></td>
                                <td><%= order.createdAt.toString().slice(0, 16)%></td>
                                <td><%= order.items.length %></td>
                                <td><%= order.totalAmt %></td>
                                <td><%= order.paymentMethod %></td>
                              </tr>
                          <% }); %>
                        </tbody>
                        
                    </table>
                  </div>
                </div>
              </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>
        
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="/javascripts/activeNavbar.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
        <!-- Data Table JS -->
        <script src='https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js'></script>
        <script src='https://cdn.datatables.net/responsive/2.1.0/js/dataTables.responsive.min.js'></script>
        <script src='https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js'></script>
        <!-- Include EJS -->
        <script src="https://unpkg.com/ejs"></script>
        <script src="/javascripts/salesReport.js"></script>

        <script>
          const table =document.querySelector('#table-body');
          window.values = {COD:true,Wallet:true,Card:true}
         const handleChange = (event) =>{
          
          const values = window.values;
          values[event.target.name] = event.target.checked;
          console.log(values)
          const body = JSON.stringify(window.values);
          fetch('/admin/filterReport',{
            method:"POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body,
          }).then(res => res.json())
          .then(orders =>{
            let orderRows = '';
            orders.forEach(order => {
              orderRows += `<tr>
                                <td>${ order._id }</td>
                                <td>${ order.userId?.name}</td>
                                <td>${ order.createdAt.toString().slice(0, 24) }</td>
                                <td>${ order.items.length }</td>
                                <td>${ order.totalAmt }</td>
                                <td>${ order.paymentMethod }</td>
                              </tr>`
            });
            table.innerHTML = orderRows;
          })
         }
        </script>

        <script>

          const downloadPdf = ()=>{
            const pdf = new jsPDF();
            pdf.autoTable({ html: '#salesReport' })
            window.open(URL.createObjectURL(pdf.output("blob")))
          }

        </script>
        


      <%- include('partials/closingHead.ejs') %>